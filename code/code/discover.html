<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barking Around MD - Discover</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.css" rel="stylesheet" />
</head>
<body>

<header>
  <div class="logo">Barking Around MD</div>
  <nav class="main-nav" aria-label="Main navigation">
    <a href="index.html">Home</a>
    <a href="discover.html">Discover</a>
    <a href="events.html">Events</a>
    <a href="posts.html">Posts</a>
    <a href="profile.html">Profile</a>
  </nav>
</header>

<br></br>

<main class="container">
  <h1>Discover Dog-Friendly Locations</h1>
  
  <!-- Map Container -->
  <div id="map" style="width: 100%; height: 400px; border-radius: 0.5em; margin-top: 2em;"></div>

  <p style="text-align: center; margin-top: 2em;">
  Click a location to find out more information!
  </p>

  <h2 style="text-align: center; margin-top: 1.5em;">
  Found a new dog friendly location?<br>Fill out the form to submit it to the map!
  </h2>

  <!-- "Add Location" Form -->
  <form id="newForm" style="margin-top: 1em; background: #f7f7f7; padding: 1em; border-radius: 0.5em; max-width: 500px; font-family: inherit; display: block !important;">
    <label>Location Name:</label>
    <input type="text" id="name" required />

    <label>Description:</label>
    <textarea id="description" required></textarea>

    <label>Street Address:</label>
    <input type="text" id="street" required />

    <label>City:</label>
    <input type="text" id="city" required />

    <label>State / Province:</label>
    <input type="text" id="state" required />

    <label>ZIP / Postal Code:</label>
    <input type="text" id="zip" required />

    <label>Country:</label>
    <input type="text" id="country" required />

    <button type="submit" style="margin: 15px auto 0; display: block;">Add to Map!</button>

  </form>

</main>

<footer>
  Created by Alyssa Teramoto & Shayaan Salahuddin
</footer>

<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.js"></script>

<!-- Script for Mapbox Setup!-->
<script>
  //ater0528 personal mapbox access token
  mapboxgl.accessToken = 'pk.eyJ1IjoiY3VjdW1iZXIxNjc4IiwiYSI6ImNtOWtmNWU1cDBrZzgya3M2YzRjMDF5bTIifQ.RHnqaotFxTos0v5bfgyGMw'; //ater0528 personal mapbox token
  
  // on startup of the page, map opens up at the specified center location
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-77.150485, 39.034381], //center on Rockville, MD area (default)
    zoom: 12
  });


  // Load saved markers on page load; throws an error if it failed to do so
  async function loadSavedLocations() {
    try {
      const res = await fetch('/locations');
      const locations = await res.json();

      locations.forEach(loc => {
        new mapboxgl.Marker()
          .setLngLat(loc.coordinates)
          .setPopup(new mapboxgl.Popup().setHTML(`
            <strong>${loc.name}</strong><br>
            ${loc.address}<br>
            <em>${loc.description}</em>
          `))
          .addTo(map);
      });
    } catch (err) {
      console.error('Failed to load saved locations:', err);
    }
  }

  loadSavedLocations();

  /*
    When a user submits the form, store all inputted information, create a full address,
    generate the coordinates, plot on the map, and 'fly' to the added in location.
    Error catching if an invalid address is inputted. 
  */
  document.getElementById('newForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const description = document.getElementById('description').value;
    const street = document.getElementById('street').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zip = document.getElementById('zip').value;
    const country = document.getElementById('country').value;

    const fullAddress = `${street}, ${city}, ${state} ${zip}, ${country}`;
    const geocodeUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(fullAddress)}.json?access_token=${mapboxgl.accessToken}`;

    const geoRes = await fetch(geocodeUrl);
    const geoData = await geoRes.json();

    if (!geoData.features.length) {
      alert('Address not found');
      return;
    }

    const coords = geoData.features[0].geometry.coordinates;

    new mapboxgl.Marker()
      .setLngLat(coords)
      .setPopup(new mapboxgl.Popup().setHTML(`<strong>${name}</strong><br>${fullAddress}<br><em>${description}</em>`))
      .addTo(map);

    map.flyTo({ center: coords, zoom: 12 });

    await fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        description,
        address: fullAddress,
        street,
        city,
        state,
        zip,
        country,
        coordinates: coords
      })
    });

    const userData = JSON.parse(localStorage.getItem('userData')) || {};
    const username = userData.username || "Anonymous";
    const locations = JSON.parse(localStorage.getItem('locations')) || [];
    locations.push({
      name,
      description,
      address: fullAddress,
      coordinates: coords,
      username // <-- add this line
    });
    localStorage.setItem('locations', JSON.stringify(locations));

    document.getElementById('newForm').reset();
  });
</script>

</body>
</html>
